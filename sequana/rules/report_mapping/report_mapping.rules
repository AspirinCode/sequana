include: sm.modules['dag']     # Create DAG file


try:
    __report_mapping__output = "report/report_denovo.html" 
    rule report_denovo:
        input:
            dag = "report/dag.svg",
            bed = __report_mapping__input,
            bam = __report_mapping__bam_input,
            quast = __report_mapping__quast_input
        output:
            __report_mapping__output
        params:
            outdir = "report",
            k = config["report_mapping"]["k"],
            size = config["report_mapping"]["window_size"],
            first = config["report_mapping"]["first_threshold"],
            second = config["report_mapping"]["second_threshold"],
            circular = config["report_mapping"]["circular"]
        run:
            import os
    
            from sequana import bedtools
            from sequana import BAM
            from sequana.reporting import report_mapping
            from sequana.reporting import report_chromosome
            from sequana.reporting import report_main
    
            
            s = report_main.SequanaReport(snakefile=__snakefile__,
                    directory=params.outdir)
            s.jinja['description'] = """
    
            This is the output of denovo assembly. This pipeline generates an
            assembly with spades. It evaluates the assembly with a remapping
            of reads on contigs.
    
            """
            s.create_report()
    
            mydata = bedtools.GenomeCov(input.bed)
            bam = BAM(input.bam)
    
            # Report mapping
            r = report_mapping.MappingReport(directory=params.outdir,
                project=cfg.PROJECT, output_filename="report_denovo.html")
            r.set_data(mydata, bam, input.quast)
            r.create_report()
    
            # Report chromosomes
            for chrom in mydata:
                chrom.running_median(n=params.size, circular=params.circular)
                chrom.compute_zscore(k=params.k)
    
                r = report_chromosome.ChromosomeMappingReport(chrom,
                    first_thr=params.first, second_thr=params.second,
                    directory=params.outdir, project=cfg.PROJECT)
                r.create_report()
    
            shell("cp %s %s/" % (__snakefile__, params.outdir))

except NameError:
    __report_mapping__output = "report/report_mapping.html"
    rule report_mapping:
        input:
            dag = "report/dag.svg",
            bed = __report_mapping__input,
            bam = __report_mapping__bam_input
        output:
            __report_mapping__output
        params:
            outdir = "report",
            k = config["report_mapping"]["k"],
            size = config["report_mapping"]["window_size"],
            first = config["report_mapping"]["first_threshold"],
            second = config["report_mapping"]["second_threshold"],
            circular = config["report_mapping"]["circular"],
            ann_file = __report_mapping__ann,
            ann_fmt = __report_mapping__ann_format
        run:
            import os
    
            from sequana import bedtools
            from sequana import BAM
            from sequana.reporting import report_mapping
            from sequana.reporting import report_chromosome
            from sequana.reporting import report_main
    

            s = report_main.SequanaReport(snakefile=__snakefile__,
                    directory=params.outdir)
            s.jinja['description'] = """
    
            This is the output of variant calling pipeline. This pipeline search
            variants and provide as an output a vcf file.
    
            """
            s.create_report()

            mydata = bedtools.GenomeCov(input.bed)
            bam = BAM(input.bam)
            
            ann_bed = ""
            if params.ann_file:
                ann_bed = params.outdir + "tmp.ann.bed"
                bed = bedtools.BedConverter(params.ann_file, params.ann_fmt)
                bed.write_bed_file(ann_bed)
            
            # Report mapping
            r = report_mapping.MappingReport(directory=params.outdir,
                project=cfg.PROJECT)
            r.set_data(mydata, bam)
            r.create_report()
    
            # Report chromosomes
            for chrom in mydata:
                chrom.running_median(n=params.size, circular=params.circular)
                chrom.compute_zscore(k=params.k)
    
                r = report_chromosome.ChromosomeMappingReport(chrom,
                    first_thr=params.first, second_thr=params.second,
                    directory=params.outdir, project=cfg.PROJECT, ann=ann_bed)
                r.create_report()
    
            shell("cp %s %s/" % (__snakefile__, params.outdir))
