


rule busco:
    """

    We need to create a temporary file for the configuration file
    Let us save it in the directory of the analysis

    """
    input: __busco__input
    output: __busco__output
    params:
        mode    = config['busco']['mode_choice'],
        options = config['busco']['options'],
        wkdir   =  __busco__workdir,
        species = config['busco']['species_choice'],
    log: __busco__log
    threads: config['busco']["threads"]
    run:
        import os
        from sequana import busco

        sample_name = params.wkdir.split(os.sep)[0]

        conda_bin_path = os.environ['CONDA_PREFIX'] + os.sep +"bin"
        augustus_config_path = os.environ['CONDA_PREFIX'] + os.sep +"config"

        config = busco.BuscoConfig(
            params.species,
            sample_name=sample_name,
            outpath=params.wkdir,
            conda_bin_path=conda_bin_path,
            Rscript_bin_path="", # not required by our analysis
            tmp_path="./tmp_{}".format(sample_name)
        )
        config_filename = params.wkdir + "/config.ini"
        config.save_config_file(config_filename)

        cmd = "export BUSCO_CONFIG_FILE={};".format(config_filename)
        cmd += "export AUGUSTUS_CONFIG_PATH={} ;".format(augustus_config_path)
        cmd += "run_BUSCO.py -i {input[0]} -m {params.mode} -c {threads} -f 2>>{log};"

        # -f to force overwritten existing files
        shell(cmd)
        shell("rm -rf ./tmp_{}".format(sample_name))











