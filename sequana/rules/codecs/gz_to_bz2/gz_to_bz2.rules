rule gz_to_bz2:
    """Convert fastq.gz files to fastq.bz2 files

    Description:
        First, the input fastq.gz file is decompressed to a fastq file.
        Second, the fastq file is compressed to a BZ2 file.


    :param input: fastq.gz file
    :return: fastq.bz2 file
    :third-party executables: pbzip2 and unpigz
    :note: uses a wildcard {dataset}

    """
    input: "{dataset}.gz"
    output: "{dataset}.bz2"
    threads: config['compressor']['threads']
    run:
        #shell("unpigz {input} -p {threads}")
        #output = output[0].replace(".bz2", "")
        #shell("pbzip2 %s -p{threads}" % output)

        cmd = "pigz -p{threads} --test {input}" 
        shell(cmd)

        cmd = "pigz -d -c -p {threads} {input} | pbzip2 -p{threads} > {output}"
        shell(cmd)

        cmd = "pbzip2 {output} -p{threads} --test"
        shell(cmd)

        # once done and integraty is checked, we removed the input file
        cmd = "rm -f {input}"
        shell(cmd)

